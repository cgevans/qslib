# This file is autogenerated by maturin v1.8.2
# To update, run
#
#    maturin generate-ci github --pytest
#
name: CI

on:
  push:
    branches:
      - main
      - master
    tags:
      - '*'
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  linux:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: ubuntu-24.04
            target: x86_64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          #sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.platform.target }}
          path: dist
      - name: Install uv
        if: ${{ startsWith(matrix.platform.target, 'x86_64') }}
        uses: astral-sh/setup-uv@v4
      - name: pytest
        if: ${{ startsWith(matrix.platform.target, 'x86_64') }}
        shell: bash
        run: |
          set -e
          uv venv
          source .venv/bin/activate
          uv sync --group dev --no-install-project
          uv pip install qslib --find-links dist --force-reinstall
          pytest -k 'not test_real' --cov qslib --cov-report xml --cov-report term
      - name: Upload coverage
        if: ${{ startsWith(matrix.platform.target, 'x86_64') }}
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          name: python-linux-${{ matrix.platform.target }}
          token: ${{ secrets.CODECOV_TOKEN }}
      - name: pytest
        if: ${{ !startsWith(matrix.platform.target, 'x86') && matrix.platform.target != 'ppc64' }}
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: ${{ matrix.platform.target }}
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y --no-install-recommends python3 python3-pip
            pip3 install -U pip
          run: |
            set -e
            pip3 install qslib --find-links dist --force-reinstall
            pip3 install pytest pytest-cov pytest-asyncio hypothesis setuptools
            pytest -k 'not test_real'
      - name: Trigger RTDs build
        uses: dfm/rtds-action@v1
        if: ${{ startsWith(matrix.platform.target, 'x86_64') }}
        with:
          webhook_url: ${{ secrets.RTDS_WEBHOOK_URL }}
          webhook_token: ${{ secrets.RTDS_WEBHOOK_TOKEN }}
          commit_ref: ${{ github.ref }}

  # musllinux:
  #   runs-on: ${{ matrix.platform.runner }}
  #   strategy:
  #     matrix:
  #       platform:
  #         - runner: ubuntu-22.04
  #           target: x86_64
  #         # - runner: ubuntu-22.04
  #         #   target: x86
  #         - runner: ubuntu-22.04
  #           target: aarch64
  #         # - runner: ubuntu-22.04
  #         #   target: armv7
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: 3.x
  #     - name: Build wheels
  #       uses: PyO3/maturin-action@v1
  #       with:
  #         target: ${{ matrix.platform.target }}
  #         args: --release --out dist --find-interpreter
  #         sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
  #         manylinux: musllinux_1_2
  #     - name: Upload wheels
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: wheels-musllinux-${{ matrix.platform.target }}
  #         path: dist
  #     - name: pytest
  #       if: ${{ startsWith(matrix.platform.target, 'x86_64') }}
  #       uses: addnab/docker-run-action@v3
  #       with:
  #         image: alpine:latest
  #         options: -v ${{ github.workspace }}:/io -w /io
  #         run: |
  #           set -e
  #           apk add py3-pip py3-virtualenv
  #           python3 -m virtualenv .venv
  #           source .venv/bin/activate
  #           pip install qslib[testing] --no-index --find-links dist --force-reinstall
  #           pip install pytest
  #           pytest -k 'not test_real'
  #     - name: pytest
  #       if: ${{ !startsWith(matrix.platform.target, 'x86') }}
  #       uses: uraimo/run-on-arch-action@v2
  #       with:
  #         arch: ${{ matrix.platform.target }}
  #         distro: alpine_latest
  #         githubToken: ${{ github.token }}
  #         install: |
  #           apk add py3-virtualenv
  #         run: |
  #           set -e
  #           python3 -m virtualenv .venv
  #           source .venv/bin/activate
  #           pip install pytest
  #           pip install qslib[testing] --find-links dist --force-reinstall
  #           pytest -k 'not test_real'

  windows:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: windows-latest
            target: x64
          # - runner: windows-latest
          #   target: x86
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: ${{ matrix.platform.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist
      - name: Install uv
        if: ${{ !startsWith(matrix.platform.target, 'aarch64') }}
        uses: astral-sh/setup-uv@v4
      - name: pytest
        if: ${{ !startsWith(matrix.platform.target, 'aarch64') }}
        shell: bash
        run: |
          set -e
          uv venv
          source .venv/Scripts/activate
          uv sync --group dev --no-install-project
          uv pip install qslib --find-links dist --force-reinstall
          pytest -k 'not test_real' --cov qslib --cov-report xml --cov-report term
      - name: Upload coverage
        if: ${{ !startsWith(matrix.platform.target, 'aarch64') }}
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          name: python-windows-${{ matrix.platform.target }}
          token: ${{ secrets.CODECOV_TOKEN }}

  macos:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: macos-15-intel
            target: x86_64
          - runner: macos-15
            target: aarch64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: pytest
        run: |
          set -e
          uv venv
          source .venv/bin/activate
          uv sync --group dev --no-install-project
          uv pip install qslib --find-links dist --force-reinstall
          pytest -k 'not test_real' --cov qslib --cov-report xml --cov-report term
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          name: python-macos-${{ matrix.platform.target }}
          token: ${{ secrets.CODECOV_TOKEN }}

  sdist:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  release:
    name: Release
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}
    needs: [linux, windows, macos, sdist]
    permissions:
      # Use to sign the release artifacts
      id-token: write
      # Used to upload release artifacts
      contents: write
      # Used to generate artifact attestation
      attestations: write
    steps:
      - uses: actions/download-artifact@v4
      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'wheels-*/*'
      - name: Publish to PyPI
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing wheels-*/*

  rust_checks:
    name: Checks for Rust
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: clippy,llvm-tools
      - name: Set up cache
        uses: Swatinem/rust-cache@v2
        with:
          key: coverage-cargo-python-linux # ${{ matrix.os }}
        continue-on-error: true
      - name: Install carge llvm-cov
        run: cargo install cargo-llvm-cov
      - name: Run Clippy
        run: cargo clippy
      - name: Run tests and coverage
        run: |
          source <(cargo llvm-cov show-env --export-prefix)
          export CARGO_TARGET_DIR=$CARGO_LLVM_COV_TARGET_DIR
          export CARGO_INCREMENTAL=1
          cargo llvm-cov clean --workspace
          cargo test
          cargo llvm-cov --no-run --lcov --output-path coverage.lcov
      - uses: codecov/codecov-action@v5
        with:
          files: coverage.lcov
          name: rust-linux # ${{ matrix.os }}
          token: ${{ secrets.CODECOV_TOKEN }}

  python_tests_real:
    name: Python tests with machine
    runs-on: self-hosted
    env:
      QSLIB_TEST_MACHINE: localhost
      QSLIB_TEST_PORT: "7000"
      QSLIB_TEST_PASSWORD: correctpassword
      QSLIB_TEST_SSL: "false"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Create virtual environment
        run: |
          uv venv -p 3.13
      - name: Install maturin
        run: |
          uv pip install maturin
      - name: Build package
        run: |
          uv run maturin develop --release --uv
      - name: Install dev dependencies
        run: |
          uv sync --group dev --no-install-project
      - name: Run pytest with coverage
        run: |
          uv run pytest --cov qslib --cov-report xml --cov-report term
      - uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          name: python-self-hosted
          token: ${{ secrets.CODECOV_TOKEN }}

  rust_integration_tests:
    name: Rust tests with machine
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: llvm-tools
      - name: Set up cache
        uses: Swatinem/rust-cache@v2
        with:
          key: integration-tests
        continue-on-error: true
      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov
      - name: Run integration tests with coverage
        run: |
          source <(cargo llvm-cov show-env --export-prefix)
          export CARGO_TARGET_DIR=$CARGO_LLVM_COV_TARGET_DIR
          export CARGO_INCREMENTAL=1
          cargo llvm-cov clean --workspace
          cargo test --test simulator_integration -- --ignored
          cargo llvm-cov --no-run --lcov --output-path coverage-integration.lcov
      - uses: codecov/codecov-action@v5
        with:
          files: coverage-integration.lcov
          name: rust-integration
          token: ${{ secrets.CODECOV_TOKEN }}

  rust_release:
    name: Rust Crates.io Release
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/')
    needs: [rust_checks]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - name: Publish to crates.io
        run: cargo publish --allow-dirty -p qslib
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}